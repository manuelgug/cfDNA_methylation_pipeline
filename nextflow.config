/*
================================================================================
  nextflow.config  |  Universal DX cfDNA Methylation Pipeline
================================================================================
*/

manifest {
    name            = 'udx-methylation-pipeline'
    author          = 'Universal DX Bioinformatics'
    description     = 'cfDNA methylation + NGS pipeline for CRC early detection'
    version         = '1.0.0'
    nextflowVersion = '>=23.04.0'
    mainScript      = 'main.nf'
}

// ── Default process settings ──────────────────────────────────────────────────
process {
    errorStrategy = { task.exitStatus in [137,140,143] ? 'retry' : 'finish' }
    maxRetries    = 2

    withLabel: 'process_low' {
        cpus   = 2
        memory = '4.GB'
        time   = '1.h'
    }
    withLabel: 'process_medium' {
        cpus   = 4
        memory = '16.GB'
        time   = '6.h'
    }
    withLabel: 'process_high' {
        cpus   = 8
        memory = '32.GB'
        time   = '24.h'
    }
    withLabel: 'process_long' {
        cpus   = 8
        memory = '32.GB'
        time   = '72.h'
    }
    withLabel: 'process_highmem' {
        cpus   = 8
        memory = '64.GB'
        time   = '24.h'
    }
}

// ── Profiles ──────────────────────────────────────────────────────────────────
profiles {

    // -- Docker (local) --------------------------------------------------------
    docker {
        docker.enabled         = true
        docker.runOptions      = '-u $(id -u):$(id -g)'
        singularity.enabled    = false

        process {
            withName: 'FASTQC'                          { container = 'biocontainers/fastqc:v0.12.1' }
            withName: 'TRIM_GALORE'                     { container = 'quay.io/biocontainers/trim-galore:0.6.10--hdfd78af_0' }
            withName: 'BISMARK_ALIGN'                   { container = 'quay.io/biocontainers/bismark:0.24.0--hdfd78af_0' }
            withName: 'PICARD_MARKDUPLICATES'           { container = 'broadinstitute/picard:2.27.5' }
            withName: 'SAMTOOLS_FLAGSTAT'               { container = 'quay.io/biocontainers/samtools:1.18--h50ea8bc_1' }
            withName: 'BISMARK_METHYLATION_EXTRACTOR'   { container = 'quay.io/biocontainers/bismark:0.24.0--hdfd78af_0' }
            withName: 'COVERAGE_FILTER'                 { container = 'quay.io/biocontainers/bismark:0.24.0--hdfd78af_0' }
            withName: 'MULTIQC'                         { container = 'quay.io/biocontainers/multiqc:1.19--pyhdfd78af_0' }
            withName: 'FEATURE_EXTRACTION'              { container = 'docker.io/udxbio/python-ml:1.0' }
            withName: 'DIFFERENTIAL_METHYLATION'        { container = 'docker.io/udxbio/r-methylkit:1.0' }
            withName: 'CLASSIFIER_TRAIN_EVAL'           { container = 'docker.io/udxbio/python-ml:1.0' }
            withName: 'REPORT_GENERATE'                 { container = 'docker.io/udxbio/python-ml:1.0' }
        }
    }

    // -- Singularity (HPC) -----------------------------------------------------
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        docker.enabled         = false
    }

    // -- AWS Batch -------------------------------------------------------------
    aws {
        aws.region    = 'eu-west-1'
        aws.batch.cliPath = '/usr/local/bin/aws'

        process {
            executor       = 'awsbatch'
            queue          = 'udx-nf-queue'
            scratch        = true
            withLabel: 'process_high' {
                cpus   = 16
                memory = '60.GB'
            }
        }
        params.max_cpus   = 96
        params.max_memory = '256.GB'
    }

    // -- Test (CI/unit tests with tiny data) -----------------------------------
    test {
        params.input         = 'tests/samplesheet_test.csv'
        params.genome        = 'tests/data/chr22_test.fa'
        params.bismark_index = 'tests/data/bismark_index/'
        params.min_coverage  = 1
        params.n_features    = 50
        params.cv_folds      = 3
        process {
            withLabel: 'process_high' { cpus = 2; memory = '4.GB'; time = '30.m' }
        }
    }
}

// ── Timeline / trace / DAG ────────────────────────────────────────────────────
// params.outdir cannot be GString-interpolated inside these config scopes in
// all Nextflow versions — use a local Groovy variable as a workaround.
def _outdir = params.containsKey('outdir') ? params.outdir : 'results'

timeline {
    enabled   = true
    file      = "${_outdir}/pipeline_info/execution_timeline.html"
    overwrite = true
}
report {
    enabled   = true
    file      = "${_outdir}/pipeline_info/execution_report.html"
    overwrite = true
}
trace {
    enabled   = true
    file      = "${_outdir}/pipeline_info/execution_trace.txt"
    overwrite = true
    fields    = 'task_id,hash,name,status,exit,realtime,%cpu,%mem,rss,vmem,peak_rss'
}
dag {
    enabled   = true
    file      = "${_outdir}/pipeline_info/pipeline_dag.html"
    overwrite = true
}
